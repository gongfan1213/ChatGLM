
### 第8章 使用ChatGLM3的思维链构建
2022年，一篇在人工智能领域引起广泛关注的论文《Chain-of-Thought Prompting Elicits Reasoning in Large Language Models》横空出世，这篇论文首次创新性地揭示了一种名为“思维链”（Chain of Thought）的方法。该方法以独特的视角引领大语言模型逐步参与到复杂问题的分解过程中，将庞大而繁杂的问题巧妙地细化为一系列更易于处理的子问题，然后依次进行求解。这种有条不紊、层层深入的解决策略，经过实践的检验，被证明能够显著提升大模型的性能，使它在逻辑推理、问题解决以及复杂任务处理等多个方面展现出前所未有的卓越能力。

思维链的引入，如同为大语言模型打开了一扇全新的大门，它不仅提供了一种全新的推理模式，更极大地拓展了大语言模型在各种应用场景下的实用性和灵活性。通过精心构建清晰、连贯的思维链条，大模型得以更深入地理解问题的本质和内在逻辑，从而生成更准确、更有深度的回答和解决方案。这一重要成果不仅为大语言模型的进一步发展和应用奠定了坚实的基础，更激发了该领域对于未来无限可能的热烈期待。

本章将追溯思维链的起源，深入探讨在大模型中运用思维链所带来的显著优势。此外，还将结合先进的LLM技术，特别是ChatGLM终端，带领读者完成一系列思维链的实战项目。通过这些项目，读者将亲身体验到思维链在提升大模型性能、增强逻辑推理能力，以及优化问题解决方案等方面的强大威力。在思维链的指引下，大语言模型将书写更加辉煌的未来篇章。

#### 8.1 思维链初探
思维链推理作为人类智能的核心组成部分，是一种基本的认知过程。它在我们理解、分析和解决问题时发挥着重要作用。近年来，这一概念在人工智能和自然语言处理领域引起了广泛的关注和深入的研究。

在人工智能领域，研究者们致力于模拟人类的思维链推理过程，以期赋予机器类似人类的逻辑推理能力。通过构建复杂的算法和模型，他们努力使机器能够像人类一样，将复杂问题分解为一系列子问题，井有序地、逐步地解决这些子问题。这种有序的、逐步深入的解决策略，正是思维链推理的精髓所在。

思维链推理在人工智能和自然语言处理领域的广泛应用，不仅提升了机器的智能水平，也为人类带来了诸多便利。随着技术的不断进步和研究的深入，我们有理由相信，思维链推理将继续在这两个领域发挥重要作用，并推动人工智能和自然语言处理技术的持续发展。

##### 8.1.1 思维链源于对人类使用自然语言的概念来理解事物
本小节通过讲解思维链的起源来深入探讨一下“语言智能”的含义。语言智能可以被理解为一种能力，即使用基于自然语言的概念来理解事物，并在这些概念之间进行推理。这种高级的抽象与理解能力是人类所独有的，它使我们在生物界中独树一帜，成为一种“智慧物种” 。这种语言智能能力不仅是我们沟通、交流的基础，更是思考、学习、创新的关键。

语言作为人类思维和交流的主要工具，其背后蕴含着丰富的逻辑和推理信息。为了让机器更好地理解人类语言，并准确地回应各种问题，研究者们需要将思维链推理的能力融入语言模型中。通过让语言模型学习并模拟人类的思维链推理过程，使它们更加深入地理解问题的本质和内在逻辑，从而生成更为准确、更有深度的回答和解决方案。

随着科技的飞速发展，大语言模型如GLM系列等逐渐崭露头角。这些模型以“Chat”的方式与人们互动，展现出了令人惊叹的概念理解和概念推理能力。作为“语言模型”，它们能够理解单词、短语、句子的含义，但更为重要的是，它们还能够进行推理，根据已知的前提推导出新的结论，如图8-1所示。

与早期的语言模型（如Word2vec）相比，这些大模型的能力已经远远超出了仅仅得出谁与“cat”与“dog”的“特定距离”更近这样的结论。Word2vec等模型虽然能够捕捉词语之间的相似性，但它们缺乏推理能力，无法处理更复杂的语言任务。而大语言模型则能够通过多步骤的推理过程，形成必要的“中间概念”，从而辅助复杂问题的求解。

![image](https://github.com/user-attachments/assets/236fba89-fe8d-4fed-a884-37436f30272e)


这种推理能力的展现，让人们看到了大模型逼近“语言智能”的无限可能。在未来的发展中，我们有理由期待大语言模型在更多领域发挥更大的作用，为人类带来更加智能、便捷的生活体验。同时，这也将推动我们对语言智能本质理解的不断深入，为人工智能领域的发展开辟新的道路。

##### 8.1.2 思维链的优势与应用场景
在经历了深度学习和大语言模型领域的持续进步之后，现今的大型模型在常识推理能力方面已经逐渐实现了对人类水平的超越。相较于早期的语言模型在多项挑战性任务上的表现难以企及人类水平，采用了思维链提示的大语言模型在Bench Hard（BBH）评测基准的23个任务中，有17个任务的表现都显著超越了人类基线。这一成果不仅标志着大语言模型是人工智能领域的一次重大突破，更展示了大语言模型在推理能力上的飞跃式发展。

在常识推理方面，大语言模型展现出了更加深入的理解能力，尤其是对身体和互动等抽象概念的理解。以运动理解为例，思维链的引入使得模型在这方面的表现甚至超越了运动爱好者（95% vs 84%），这也充分证明了思维链提示在提升模型理解能力方面的巨大作用。

在数学逻辑推理方面，大语言模型同样取得了令人瞩目的成就。以往，语言模型在算术推理等任务上的表现往往不尽如人意，但在应用了思维链技术后，大语言模型的逻辑推理能力得到了显著提升。在MultiArith和GSM8K这两个用于测试语言模型解决数学问题能力的数据集上，使用思维链提示的大语言模型相较于传统提示学习方法，在性能方面有了显著的提升，如图8-2所示。 

![image](https://github.com/user-attachments/assets/09537677-a55c-4cd9-acfd-cf84defd07bd)


这一突破意味着大语言模型已经具备了解决那些需要精确地分步骤计算的复杂数学问题的能力，为人工智能在更广泛领域的应用开辟了新的道路。

除了性能上的提升外，大语言模型的可解释性也得到了显著改善。以往被视为黑盒的超大规模无监督深度学习模型，其推理决策过程往往难以捉摸，导致模型结果的可信度受到质疑。然而，思维链技术的引入，通过将逻辑推理问题分解成多个步骤来逐步解决，为生成的结果提供了更加清晰的逻辑链路和更高的可解释性。这使得人们能够更好地理解答案的来源和推理过程，从而增强了对模型结果的信任度。

思维链技术为大语言模型的发展注入了新的活力。它不仅解决了大模型在复杂推理任务上的性能问题，还提升了已有任务的准确性。例如，在检索+生成的问答方式中，通过应用思维链方式和限制条件，可以显著提高准确率，这对于一些追求大语言模型稳定性结果输出的场景具有重要意义。

从思维链的应用场景来看，其潜力远不止于此。复杂任务求解是思维链技术的一个重要应用方向。通过论文中给出的数学和算法求解示例可以看出，这些复杂的思维链提示工程旨在增强模型在复杂推理任务中的准确性。因此，未来我们可以期待大语言模型在解决复杂的数学问题、组合优化问题等方面展现出更强大的能力。至于能否求解NP-hard问题或找到一些启发式的算法，仍有待进一步探索和研究。

总的来说，思维链技术的引入为大语言模型的发展带来了新的契机和挑战。它不仅提升了模型的性能和可解释性，还拓展了模型的应用场景和潜力。相信未来大语言模型将在更多领域展现出更加令人惊艳的性能和能力。

#### 8.2 思维链详解及其实战
单纯扩大LLM模型的参数量，虽然在一定程度上能够增强模型的表达能力，但在面对算术推理、常识推理、符号推理等复杂推理任务时，往往难以取得理想的效果。这些推理任务要求模型具备深层次的逻辑理解能力和精确的计算能力，而这些能力并非通过增加模型参数就能轻易获得。

为了在这些推理任务上取得更好的性能，我们可以将思维链技术作为核心策略。在实施思维链技术时，首先需要针对具体的推理任务设计出合适的思维链模板。这些模板可以是一系列有序的问题，也可以是具有明确逻辑结构的指令序列。然后，将这些模板融入LLM的训练过程中，让模型学会按照思维链的指引进行推理，如图8-3所示。

![image](https://github.com/user-attachments/assets/d96ba5ea-c01e-4a02-86d3-6da36b709329)


通过引入思维链技术，LLM模型在算术推理任务上能够更好地处理数学运算和逻辑推理问题。在常识推理任务上，模型能够利用思维链中的相关知识和逻辑关系，做出更合理和准确的推断。在符号推理任务上，思维链技术可以帮助模型理解符号的含义和运算规则，从而进行正确的符号操作。

以思维链为核心的策略，为提升LLM在复杂推理任务上的性能提供了一种有效的途径。通过设计合适的思维链模板，并将其融入模型的训练过程中，我们可以引导LLM逐步参与复杂问题的分解和解决过程，从而显著提升其在算术推理、常识推理、符号推理等任务上的表现。这不仅为大语言模型的发展注入了新的活力，也为人工智能在更广泛领域的应用打开了新的大门。

##### 8.2.1 思维链详解
思维链作为一种新颖的提示学习方法，在大模型的上下文学习中展现出了独特的优势。与传统的上下文学习相比，思维链在输入中添加了更多的“闲言碎语”和“絮絮叨叨”，这些看似琐碎的信息，实际上为模型提供了更丰富的上下文背景，有助于模型更准确地理解和生成输出。

在传统的上下文学习中，大模型通常接收一系列输入样本（如x1, y1, x2, y2, …, x_test），并根据这些输入来补全并输出对应的y_test。这种方法虽然在一定程度上有效，但在处理复杂任务时，由于缺乏足够的上下文信息，模型往往难以做出准确的推断和生成。

而思维链则通过在输入中添加额外的信息弥补了这一不足。这些信息可以是与任务相关的描述、解释、示例等，它们为模型提供了更多的线索和背景知识，帮助模型更好地理解任务的本质和要求。同时，这些“闲言碎语”和“絮絮叨叨”也使得思维链更具人性化和可解释性，因为它们模拟了人类在解决问题时的思考过程。

以图8-4为例，假设我们需要模型根据问题信息进行回答。在传统的上下文学习中，模型可能只会接收问题信息作为输入，并根据本身的性能来回答。然而，在思维链中，我们可以向模型提供关于思考计算的过程等。这些信息将作为“闲言碎语”和“絮絮叨叨”被添加到输入中，从而为模型提供更全面的上下文背景。有了这些额外的信息，模型就能够更好地回答信息，生成更准确的答案。

![image](https://github.com/user-attachments/assets/b9cb6de7-7f44-4ae0-b9d9-0fa9b330f2cf)


上述例子生动地阐释了思维链的工作原理。在传统的1-shot prompting中（如图8-4左边所示），我们通常只是简单地将一个示例拼接在查询之前，以此为模型提供某种形式的上下文。然而，这种方法对于复杂推理任务往往效果有限，因为模型可能无法从单一的示例中提炼出足够的逻辑结构。

相比之下，图8-4右图展示的Chain-of-Thought（CoT）方法则是一种显著的改进。在CoT中，不仅提供了示例，还将示例中的答案拆解为一系列详细的推理步骤（这些步骤通常是人工构建的）。这样做的目的在于希望模型能够学会模仿这种逐步的推理过程，从而在面对新的查询时，能够自主地生成类似的推理步骤，并最终得出正确的答案。

通过这种方式，思维链实际上是在教授模型一种结构化的思考方法，使其能够像人类一样逐步、有条理地解决问题。这不仅提高了模型在复杂任务上的性能，还使得模型的推理过程更加透明和可解释，从而增强了人们对模型输出的信任感。

##### 8.2.2 基于ChatGLM3的思维链实战
由于思维链技术的具体应用仍在深入探索阶段，因此本节仅展示一个简单的思维链实战过程，旨在为读者提供一个初步的认识和启发。通过这一示例，期望能够激发读者对思维链技术的兴趣，进而引导读者更深入地学习和掌握这一前沿技术。示例代码如下：

```python
from 新第四章_Langchain知识图谱 import llm_chatglm
llm = llm_chatglm.ChatGLM()
prompt = """
小红有20个苹果，平均分给9个同学，多的她留下来，放学后她又买了5个苹果，现在她还有几个苹果。
"""
response = llm(prompt)
print(response)
print("---------------------------------")
```

这是一个较简单的示例，我们在这里提出一个略微复杂的数学计算问题，模型的回答如图8-5所示。


首先，我们需要计算出每个同学应该得到多少个苹果。20个苹果除以9个同学，等于2个苹果余2个苹果。所以，每个同学应该得到2个苹果，剩下2个苹果。

然后，放学后她买了5个苹果，所以现在她总共有20个苹果+5个苹果=25个苹果。

最后，我们需要确定她现在有多少个苹果。25个苹果除以9个同学，仍然等于2个苹果余5个苹果。所以，现在她还有5个苹果。


![image](https://github.com/user-attachments/assets/ca5008cb-9271-4232-a56a-c767289e7839)


可以看到，此时的计算结果明显是错误的，究其原因可能是在第二步计算时出错。下面我们换一种提示方法，即使用CoT的问答方案完成数学问题的计算，代码如下：

```python
from 新第四章_Langchain知识图谱 import llm_chatglm
llm = llm_chatglm.ChatGLM()
prompt = """
小红有20个苹果，平均分给9个同学，多的她留下来，放学后她又买了5个苹果，现在她还有几个苹果。

你可以参考下面的解题步骤，仅作解题示例，你要仿照解题示例完成回答，写出详细步骤：
问题：
小明爱打乒乓球，他现在有5个球，他又买了2罐，每罐有3个球。他现在有多少个乒乓球？
回答：
小明现在有的乒乓球数可以通过以下步骤计算：
1. 计算小明原有的乒乓球数量，根据题目已知他有5个乒乓球。
2. 计算小明通过购买罐装球获得的乒乓球数量。
   他买了2罐球，每罐有3个乒乓球，因此通过购买他获得了2×3=6个乒乓球。
3. 将小明原有的乒乓球数量和他通过购买获得的乒乓球数量相加，即可得到他现在总共有的乒乓球数量。
   即：5+6=11个乒乓球。
4. 小明现在有11个乒乓球。
"""
llm.history = []
response = llm(prompt)
print(response)
```

解题步骤和结果如图8-6所示。

问题：

小红有20个苹果，平均分给9个同学，多的她留下来，放学后她又买了5个苹果，现在她还有几个苹果。

答案：

我们可以按照以下步骤计算小红现在还有多少个苹果：

1. 首先，我们需要计算小红平均分给9个同学后，每个同学得到多少个苹果。由于小红一共有20个苹果，所以每个同学得到的苹果数量为：20 / 9 = 2个苹果（余数为2个苹果）。

2. 接着，我们需要计算小红通过购买5个苹果后，她总共拥有多少个苹果。她原本有20个苹果，购买5个苹果后，总共有：20 + 5 = 25个苹果。

3. 最后，我们需要计算小红现在拥有多少个苹果。由于她总共拥有25个苹果，而她分给9个同学后，每个同学得到2个苹果，所以她现在剩下的苹果数量为：25 - (9 × 2) = 25 - 18 = 7个苹果。


因此，现在小红还剩下7个苹果。

此时，通过提供一个详细的解题过程，可以得到一个正确的答案。

尽管这个示例相对简单，但它涵盖了思维链技术的基本要素和核心思想。通过观察和分析这个示例，读者可以初步了解思维链技术是如何工作的，以及它如何帮助模型进行有序、逐步深入的推理。

同时，也希望这个示例能够引发读者的思考，激发读者的创造力。思维链技术是一个前沿且充满潜力的研究领域，相信读者在进一步学习和探索的过程中，一定能够有所收获，并为这一领域的发展做出自己的贡献。

![image](https://github.com/user-attachments/assets/ba8e8b8f-4954-42c4-b352-8c84a40e8b9b)


#### 8.3 本章小结
在本章中，我们深入探讨了思维链的起源、应用优势以及广泛的应用场景。思维链作为一种模拟人类逐步推理的方法，其起源可追溯至对人类认知过程的研究，旨在让机器能够像人类一样进行有序、逐步深入的思考。

在应用优势方面，思维链显著提升了大语言模型在复杂推理任务中的性能。通过引导模型逐步分析问题、提取关键信息并做出推理，思维链帮助模型更好地理解问题本质，从而提高了答案的准确性和可靠性。此外，思维链还增强了模型的可解释性，使得人们更容易理解模型的推理过程和决策依据。

在应用场景方面，思维链展现出了极大的潜力。无论是算术推理、常识推理，还是其他复杂的认知任务，思维链都能为模型提供有力的支持。例如，在算术推理中，思维链可以帮助模型理解数学问题的结构，并按照正确的顺序执行计算步骤；在常识推理中，思维链则能够引导模型分析问题的背景、相关知识和逻辑
关系，从而得出合理的结论。 

最后，以Chain - of - Thought为例，详细实战了思维链的提示模板构建过程。通过这一实战案例，读者可以更加直观地了解如何在实际应用中运用思维链技术，为模型提供清晰、有序的推理路径。 

思维链作为一种引导模型进行逐步推理的方法，具有广泛的应用前景。在未来的研究和应用中，相信思维链将在更多领域发挥重要作用，推动人工智能技术的持续进步。因此，鼓励读者在阅读本书的基础上，进一步学习和探索思维链技术，以期在未来的研究和应用中取得更多的成果。 
