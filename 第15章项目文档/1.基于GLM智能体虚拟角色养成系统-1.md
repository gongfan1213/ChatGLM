### 第15章 基于GLM智能体虚拟角色养成系统
本章旨在详细介绍基于GLM智能体虚拟角色养成系统（GLM - based Agent System for Virtual Role Cultivation, GAS）的开发案例。本章将从需求分析入手，深入探讨系统设计、数据库设计、算法流程、页面设计以及后端接口实现等关键环节。通过精心构建的用例分析和E - R图，本章将展示如何将用户需求转化为具体的系统功能，并确保这些功能能够高效、稳定地运行。此外，本章还将提供系统的测试流程和使用说明，以及完整的部署指南，确保读者能够全面理解并实践本系统的开发和应用。

#### 15.1 需求分析
一个成功的系统开发项目不仅依赖于先进的技术，更依赖于对用户需求的深入理解和精确捕捉。需求分析作为系统开发生命周期中的第一个阶段，其重要性不言而喻。本节将针对本项目的需求分析工作进行详细阐述，包括需求描述、系统用例分析和E - R图。

##### 15.1.1 需求描述

本章需要开发一个基于GLM智能体虚拟角色养成系统，该系统以大模型的技术为基础，在功能性需求方面涉及六大功能类别。六大功能分别为：账号管理功能、智能体管理功能、智能生成头像功能、角色扮演功能、智能报表功能和长文档解读功能。其中角色扮演功能、智能报表功能和长文档解读功能都是由创建的智能体实现。

1. **账号管理功能**

账号管理功能包含对使用本系统的用户信息（包括用户名、用户密码、用户头像和用户创建的角色信息等）进行管理（包括添加、删除、修改和查询等功能），以及为保证系统的安全性，对使用本系统的用户进行权限管理，分配不同的用户角色（管理员和普通用户）等对用户的账户进行操作的功能。

2. **智能体管理功能**

智能体管理功能包含对用户拥有智能体的信息（智能体名称、智能体人设、智能体头像和智能体类别等）进行管理，包括智能体的创建、删除、修改和查询等操作，以及决定创建的智能体是否共享给所有用户的功能。系统中智能体共有三种，分别是角色扮演智能体，报表智能体和长文档解读智能体。

3. **智能生成头像功能**

智能生成头像功能需要满足根据提供头像的文本描述就能生成符合文本内容的头像的功能。

4. **角色扮演功能**

角色扮演功能需要使角色扮演智能体能够与用户进行聊天对话，还需要角色回复的内容要符合角色的人设，并且对话过程中角色要具备一定的记忆性，使整体对话过程流畅通顺。

5. **智能报表功能**

智能报表功能需要报表智能体能够根据用户的问题给出相应的绘制报表的代码和执行代码得到的结果。

6. **长文档解读功能**

长文档解读功能需要长文档解读智能体能够根据用户上传的文档来回答问题，并且回答的内容要符合文档里的内容。



##### 15.1.2 系统用例分析

![image](https://github.com/user-attachments/assets/4286c371-26d7-4807-a003-f66efe16f49a)


通过对客户端业务的用例分析，描述系统如何被各个角色所使用、系统提供何种服务给角色。本项目通过分析系统的用例和角色之间的关系，明确用户对客户端功能上的需求。图15 - 1为GAS的用例分析图，通过对用例图的详细分析，很容易理清角色与服务的关系。



**图15 - 1 GAS的用例分析图**

基于GLM智能体虚拟角色养成系统

- 用户：登录、注册、创建智能体、查询智能体、修改智能体、删除智能体、账号管理、退出系统
  - 创建智能体：角色扮演、智能报表、长文档解读
  - 账号管理：查询账号、编辑账号、删除账号、修改用户角色
- 管理员：登录、注册、创建智能体、查询智能体、修改智能体、删除智能体、账号管理、退出系统
  - 创建智能体：角色扮演、智能报表、长文档解读
  - 账号管理：查询账号、编辑账号、删除账号、修改用户角色

##### 15.1.3 E - R图

实体联系表示法简称E - R方法，此方法通过E - R图（Entry - Relationship）表示实体及其联系，E - R图用于设计数据库表结构。

E - R图中包括实体、属性和联系三种基本图素。实体用方框表示，实体属性用椭圆框表示，联系用菱形框表示。将有联系的实体（方框）通过联系（菱形框）连接起来，注明联系方式，再将联系的属性（椭圆框）连到相应的实体上。

E - R图的设计原则是：先局部后整体，在综合的过程中，去除重复的实体，去掉不必要的联系。注意，能作为属性的就不要作为实体。

GAS v1.0的E - R图设计如图15 - 2所示，图中描述了系统中实体（Entity）之间的联系（Relationship），并且给出了所有实体的全部属性。

![image](https://github.com/user-attachments/assets/b9b72f1f-e4d8-45fb-b0e9-e71cd399cdef)


**图15 - 2 GAS E - R图**
- 用户
  - 属性：头像描述、用户密码、用户名、用户ID、头像URL、注册时间、更新时间、用户角色、账户状态
  - 关系：拥有智能体（N - M）、拥有聊天记录（1 - 1）
- 智能体
  - 属性：用户ID、智能体ID、智能体名称、智能体信息、智能体类别、头像描述、头像URL、创建时间、更新时间、是否共享、智能体状态、知识库ID
  - 关系：被用户拥有（M - N）、拥有会话（1 - M）
- 聊天记录
  - 属性：会话ID、聊天记录ID、发送者、消息内容、创建时间
  - 关系：被用户拥有（1 - 1）、属于会话（1 - 1）
- 会话
  - 属性：会话ID、用户ID、角色ID、创建时间、会话状态
  - 关系：被智能体拥有（M - 1）、拥有聊天记录（1 - 1）

#### 15.2 总体设计
GAS v1.0主要采用B/S结构，应用大模型的技术，需要实现智能体管理、角色扮演、智能报表等功能，其算法模型的开发语言为Python，系统可视化页面设计语言为HTML和CSS，以及数据库查询语言为SQL。如图15 - 3所示，GAS的总体架构采用系统界面为中间层，以初始角色数据和ChatGLM为基础实现上层的6个模块（包括智能体管理、头像生成、角色扮演、智能报表、长文档解读和账号管理）的用户交互服务。

![image](https://github.com/user-attachments/assets/fcb0112f-dc42-4312-ab6e-93da65013de7)


**图15 - 3 GAS v1.0总体架构图**
- 上层模块：智能体管理、头像生成、角色扮演、智能报表、长文档解读、账号管理
- 中间层：系统界面
- 底层：数据库、ChatGLM
- 关系：获取微调ChatGLM所需数据

#### 15.3 详细设计
##### 15.3.1 表结构设计
GAS v1.0的数据库表结构设计见表15 - 1 ~ 表15 - 4。
**表15 - 1 用户表（users）**
|字段名称|中文描述|字段类型|可否为空|说明|
| ---- | ---- | ---- | ---- | ---- |
|uid|用户ID|Int(11)|否|自增，主键|
|name|用户名|Varchar(11)|否| |
|password|用户密码|Varchar(64)|否|密码的加盐哈希值|
|avatar_description|头像的文本描述|Varchar(256)|可| |
|avatar_url|用户头像url|Varchar(256)|否|图片地址链接url|
|role|用户角色|Varchar(16)|否|user、admin|
|created_at|注册时间|Timestamp|否| |
|updated_at|更新时间|Timestamp|可| |
|is_deleted|账户状态|Bool|否|t, f|

**表15 - 2 智能体表（agents）**
|字段名称|中文描述|字段类型|可否为空|说明|
| ---- | ---- | ---- | ---- | ---- |
|cid|智能体ID|Int(11)|否|自增，主键|
|uid|用户ID|Int(11)|否| |
|name|智能体名称|Varchar(32)|否| |
|description|智能体信息|Varchar(256)|否| |
|category|智能体类别|Varchar(8)|否|food、travel、tech、health、law、reporter、retriever、other|
|avatar_description|头像的文本描述|Varchar(256)|可| |
|avatar_url|智能体头像|Varchar(256)|否|图片地址链接url|
|created_at|创建时间|Timestamp|否| |
|updated_at|更新时间|Timestamp|可| |
|is_shared|是否为共享智能体|Bool|否|t, f|
|is_deleted|智能体状态|Bool|否|t, f|
|knowledge_id|知识库ID|Int(11)|可| |

**表15 - 3 会话表（chats）**
|字段名称|中文描述|字段类型|可否为空|说明|
| ---- | ---- | ---- | ---- | ---- |
|chat_id|会话ID|Int(11)|否|自增，主键|
|uid|用户ID|Int(11)|否| |
|cid|智能体ID|Int(11)|否| |
|created_at|创建时间|Timestamp|否| |
|is_deleted|会话状态|Bool|否|t, f|

**表15 - 4 聊天记录表（messages）**
|字段名称|中文描述|字段类型|可否为空|说明|
| ---- | ---- | ---- | ---- | ---- |
|mid|聊天记录ID|Int(11)|否|自增，主键|
|chat_id|会话ID|Int(11)|否| |
|sender|发送者|Varchar(8)|否|user、assistant|
|content|发送内容|Varchar(255)|否| |
|created_at|创建时间|Timestamp|否| |

##### 15.3.2 系统流程图

1. **系统程序流程**

案例系统的程序流程如图15 - 4所示。

![image](https://github.com/user-attachments/assets/7392e357-43f7-4893-940e-0d800a6ff86f)


**图15 - 4 系统流程图**
开始
- 判断是否有系统账号
  - 否：注册账号
  - 是：登录系统
- 判断操作
  - 否：退出系统
  - 是：选择操作（创建智能体、删除智能体、修改智能体、角色扮演、智能报表、长文档解读）
结束

程序流程图从宏观的角度给出了案例系统的操作方向和流程，其中，“带方向箭头”表示操作方向，“菱形”表示判断，“矩形”表示一个完整的模块功能。

2. **注册流程**

注册系统账号的流程如图15 - 5所示。

![image](https://github.com/user-attachments/assets/44ab5c97-db65-4deb-8ab1-2ffe2988389b)


**图15 - 5 注册流程图**

开始
- 进入注册页面
- 输入用户名、密码
- 判断用户名是否已存在
  - 是：重新输入用户名
  - 否：判断密码格式是否正确
    - 是：注册成功
    - 否：重新输入密码
结束

该流程包含两部分功能：

1）验证用户名是否存在，每个用户的用户名都是唯一的，不允许出现相同的用户名。

2）验证密码是否正确，这是从安全的角度考虑，防止非法修改密码。



##### 15.3.3 页面设计

依据GAS的功能分析，以及软件体系结构设计方案，本节对系统进行了初步的界面设计。该系统总共由12个页面组成，分别是登录页面、注册页面、系统首页、个人信息页面、对话页面、修改智能体页面、创建智能体页面、账号管理页面、新增账号页面、编辑账号页面、智能体管理页面和编辑智能体页面。

1. **登录页面**

在登录页面中，用户需要输入用户名和密码进行登录，单击登录按钮后如果登录成功将进入系统首页，如果登录失败将提示用户名或密码错误。在输入框中要显示用户名和密码的提示信息（如用户名不能超过11位等）。若用户还没有系统账户，可以单击注册按钮进行账号注册。登录页面简要设计如图15 - 6所示。

2. **注册页面**

注册页面如图15 - 7所示，用户单击注册按钮后进入该页面。用户需要输入用户名、密码进行账号注册。用户头像框用于输入头像的文本描述，然后单击生成会自动生成头像，不选择则系统默认设置头像。

![image](https://github.com/user-attachments/assets/ba39c7fc-71e8-4145-bfe7-8da23ca88e24)


3. **系统首页**

当单击登录按钮登录成功后，将会进入系统首页，首页设计图如图15 - 8所示。整个系统页面框架都是由顶部标题栏、左侧导航栏和右侧活动栏组成。顶部标题栏由系统名称、用户头像、修改密码按钮和退出按钮组成。单击用户“头像”会进入个人信息页面，单击“退出”会退出当前登录账号。左侧导航栏有四个选项，单击“首页”对应右侧显示首页信息，单击“对话”对应右侧显示对话页面，单击“创建智能体”对应右侧显示创建智能体页面，单击“账号管理”对应右侧显示账号管理页面。登录成功进入系统时右侧默认显示首页信息，首页展示了用户拥有的所有智能体信息（智能体名称、智能体类别、智能体头像），单击智能体头像将进入与该智能体的对话页面。右侧活动栏上方也提供了用户根据智能体名称搜索智能体的功能。

![image](https://github.com/user-attachments/assets/3a2f1343-a59b-493f-8012-7da45ab660ce)


4. **个人信息页面**

个人信息页面如图15 - 9所示，当上方选择框选择“不修改”时，页面显示用户名、用户头像，当选择“修改”时，可对用户名和头像进行修改。

![image](https://github.com/user-attachments/assets/3f4b7dc8-fb98-4110-bb00-15e09bb51ecb)


5. **对话页面**
   
如图15 - 10所示，对话页面由三部分组成，上方的智能体信息显示栏，下方的发送消息栏和中间的对话显示栏。单击上方“更多”中的“删除”智能体时，该智能体将会被删除，自动跳转到首页；单击“修改”智能体时，将进入修改智能体页面；单击“新建会话”，将清空聊天记录，创建一个新的对话窗口。根据用户选择的智能体的类型不同，该对话页面分别能与角色扮演、智能报表和长文档解读智能体进行对话。 
